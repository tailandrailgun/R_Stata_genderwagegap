---
title: "LFS2021"
author: "Jian Hao, Isanna"
date: ''
output:
  pdf_document: default
  html_document: default
subtitle: OLS
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set global R options
#options("scipen"=10, "digits"=4)

# kable
options(knitr.kable.NA = '')

# Set the graphical theme
ggplot2::theme_set(ggplot2::theme_light())

# load libraries -- install if required
library(pacman)
p_load(tidyverse,
       dplyr,
       oaxaca,
       knitr,
       ggplot2,
       haven,
       Hmisc,
       survival,
       Formula,
       lattice,
       matrixStats,
       fastDummies,
       magrittr)
      
```

<div class="alert alert-info">
  <strong>Group Members:</strong> 
1. Jian Hao Chiah, 216031965
2. Isanna Biglands, 218887273
</div>

## Introduction 

While we have tried to utilize the 'oaxaca' package available, you will see NA values returned for important statistics generated by the procedure. The reason behind this is that, as LFS Canada is based of survey data, this is not compatible with the 'oaxaca' R package as it does not allow us to input data weights anywhere.Therefore, please refer to the `STATA` procedures and output included in this submission for the decomposition approach conducted.  

All data cleaning, data manipulation and statistical procedures we have performed in both data tools -- STATA & R are identical. The main difference between two series of work in this Appendix section is the following:

`R`: Overlapping Density Plots based on Gender, Average Wage Differences by Wages, Standard Deviation of Log Wages, OLS Regression 

`STATA`: Blinder–Oaxaca decomposition

Notes: 
1. For year 2019, 2016, 2014 I did not display the output for 'oaxaca' in R as they are meaningless to our study. Please refer to our analysis and STATA output specifically for Blinder–Oaxaca decomposition.


# Part 1: Importing Data & Data Manipulation

## The code below imports the LFS data for year 2021 into R.
```{r, echo=TRUE}
lfs2021 <- read.csv("D:/Desktop/PROC A/Data/2021 LFS.csv") 
```

## Data

Here I performed some data cleaning and generated dummy variables.

```{r eval=T, echo=T}
#Cleaning the data -- Part 1

lfs <- lfs2021 %>% 
  drop_na(FTPTMAIN) %>% 
  drop_na(HRLYEARN) %>%
  drop_na(PERMTEMP) %>%
  mutate(hrlywage = HRLYEARN/100,
         hours = UTOTHRS/10,
         average_weekly_wage = hrlywage*hours,
         lWAGE = log(average_weekly_wage),
         FEMALE = ifelse(SEX == 2, 1, 0),
         full_part = ifelse(FTPTMAIN == 2, 1, 0),
         perm_temp = ifelse(PERMTEMP == 2, 1, 0)) 
  
```
```{r eval=T, echo=T}
#Creating Dummies with more than 2 categories
lfs <- dummy_cols(lfs, select_columns = c('AGE_12','MARSTAT','EDUC','IMMIG', 'CMA'),
                  ignore_na = FALSE)

```
```{r eval=T, echo=T}
df <- lfs %>% 
  select(AGE_12, FEMALE, lWAGE, MARSTAT, EDUC, MJH, NAICS_21, UHRSMAIN, UTOTHRS, TENURE, UNION, SCHOOLN, AGYOWNK, FINALWT)

FEMALE.f <- factor(df$FEMALE, labels=c("men", "women"))

```

# Part 2: Overlapping Density Plots based on Gender
```{r eval=T, echo=T, results='hide'}
# Log Wage by Gender
df %>% 
  mutate(FEMALE.f <- factor(FEMALE, labels = c("MEN","WOMEN")))
```
## Log Wage by Gender
```{r eval=T, echo=T}
ggplot(df, aes(x = lWAGE, y = ..density.., weight = FINALWT, fill = FEMALE.f)) +
         geom_histogram(bins = 30, position = position_dodge(width = 0), alpha = 1) +
  labs(x = "Log Wage", y = "Density", title = "Log(wage) by Gender") +
  scale_x_log10() +
  theme_classic()
```

## Highest Educational Attainment by Gender
```{r eval=T, echo=T}
# Highest Educational Attainment by Gender
ggplot(df, aes(x = EDUC, y = ..density.., weight = FINALWT, fill = FEMALE.f)) +
  geom_histogram(bins = 20, position = position_dodge(width = 0), alpha = 1) +
  labs(x = "Highest Education Attainment", y = "Density", title = "Highest Educational Attainment by Gender") +
  theme_classic()

```
<div class="alert alert-info">
  <strong>Comments:</strong> 
The first graph compared both genders in terms of log wage, while the second graph compared both genders in terms of the participants' highest education attainment.
Bases on the two graphs generated, we can conclude the following: 
  
  In Canada, men still earns higher wage than women specifically at the higher range of wage level. On the other hand, women in Canada have higher education than men.

</div>

# Part 3: Average wage differences
## Avg.wage diff. by Gender
```{r eval=T, echo=T}
df.gen <- df %>% 
  group_by(FEMALE) %>% 
  summarise(mwage = weighted.mean(lWAGE, FINALWT),
            median.wage = weightedMedian(lWAGE, FINALWT))

df.gen
```
## Avg.wage diff. by Highest Educational Attainment
```{r eval=T, echo=T}
df.educ <- df %>% 
  group_by(EDUC) %>% 
  summarise(mean.wage = weighted.mean(lWAGE, FINALWT),
            median.wage = weightedMedian(lWAGE, FINALWT))

df.educ
```
<div class="alert alert-info">
  <strong>Comments:</strong> 
In part 3, we can observe that the average log wage difference between male and female workers is approximately 0.2426, while the average log wage difference within all education levels show that at higher educational level, the average log wage for both gender is higher. 
</div>
# Part 4: Standard deviation for Log Wages
## Std. Dev. for Log Wages by Gender
```{r eval=T, echo=T}
df.gen <- df %>% 
  group_by(FEMALE) %>% 
  summarise(std.dev.wage = sd(lWAGE, na.rm = F))

df.gen
```
## Std. Dev. for Log Wages by Highest Educational Attainment
```{r eval=T, echo=T}
df.gen <- df %>% 
  group_by(EDUC) %>% 
  summarise(std.dev.wage = sd(lWAGE, na.rm = F))

df.gen
```
<div class="alert alert-info">
  <strong>Comments:</strong> 
From part 4, we have computed the standard deviation for log wages by gender. For male, the standard deviation is 0.6836824 while for female is it 0.7204492. This set of standard deviation indicates that the data are clustered closely around the mean, which means that this data is reliable.
</div>

# Part 5: Pooled Weighted OLS model
```{r eval=T, echo=T}
OLS <- lm(lWAGE ~ FEMALE
             + AGE_12_1 
             + AGE_12_2 
             + AGE_12_3
             + AGE_12_4
             + AGE_12_5
             + AGE_12_6
             + AGE_12_7
             + AGE_12_8
             + AGE_12_9
             + AGE_12_10
             + AGE_12_11
             + AGE_12_12
             + MARSTAT_1
             + MARSTAT_2
             + MARSTAT_3
             + MARSTAT_4
             + MARSTAT_5
             + MARSTAT_6
             + EDUC_1
             + EDUC_2
             + EDUC_3
             + EDUC_4
             + EDUC_5
             + EDUC_6
             + IMMIG_1
             + IMMIG_2
             + IMMIG_3
             + CMA_1
             + CMA_1
             + CMA_2
             + CMA_3
             + CMA_4
             + CMA_5
             + CMA_6
             + CMA_7
             + CMA_8
             + CMA_9
             + full_part, weight = FINALWT, data = lfs)

summary(OLS)
  
```
<div class="alert alert-info">
  <strong>Comments:</strong> 
The OLS regression model's estimated statistical outputs show that:

1. The average wage (log) difference between both genders is -0.161649. This indicates that female earns 0.161649 less wage than male.
</div>

```{r eval=T, echo=T}
summary(OLS)$r.squared
```
<div class="alert alert-info">
  <strong>Comments:</strong> 
R-squared of 0.59873707 shows that approximately 59.87% of data fit the OLS regression model -- this model explains 59.87% of variation in the dependent variable around its mean.
</div>

# Part 6: Oaxaca-Blinder Decomposition Method based on Gender
```{r eval=T, echo=T}
#explain differences in log real wages across gender
OB <- oaxaca(formula = lWAGE ~  + AGE_12_1 
             + AGE_12_2 
             + AGE_12_3
             + AGE_12_4
             + AGE_12_5
             + AGE_12_6
             + AGE_12_7
             + AGE_12_8
             + AGE_12_9
             + AGE_12_10
             + AGE_12_11
             + AGE_12_12
             + MARSTAT_1
             + MARSTAT_2
             + MARSTAT_3
             + MARSTAT_4
             + MARSTAT_5
             + MARSTAT_6
             + EDUC_1
             + EDUC_2
             + EDUC_3
             + EDUC_4
             + EDUC_5
             + EDUC_6
             + IMMIG_1
             + IMMIG_2
             + IMMIG_3
             + CMA_1
             + CMA_1
             + CMA_2
             + CMA_3
             + CMA_4
             + CMA_5
             + CMA_6
             + CMA_7
             + CMA_8
             + CMA_9
             + full_part + perm_temp | FEMALE, data = lfs, R = 30)

print(OB)

```





